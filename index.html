<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Pet Guardian ‚Äì Game + N·∫°p/R√∫t TON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram WebApp & TonConnect SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>

  <style>
    body{
      font-family:system-ui,sans-serif;
      background:#020617;
      color:#e5e7eb;
      margin:0;
      padding:16px;
    }
    .card{
      max-width:480px;
      margin:0 auto;
      padding:20px;
      border-radius:18px;
      background:#0f172a;
      box-shadow:0 20px 40px rgba(0,0,0,0.7);
    }
    h1{text-align:center;margin-top:0;}
    .section-title{
      margin-top:16px;
      margin-bottom:6px;
      font-weight:600;
      color:#facc15;
      font-size:15px;
    }
    .label{font-size:13px;color:#9ca3af;}
    .addr-box{
      font-size:12px;
      background:#020617;
      padding:8px;
      border-radius:8px;
      word-break:break-all;
      margin-top:4px;
    }
    button{
      border:none;
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      cursor:pointer;
    }
    .primary{background:#22c55e;color:#052e16;font-weight:600;}
    .secondary{background:#334155;color:#e5e7eb;}
    .danger{background:#f97316;color:#111827;font-weight:600;}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px;}
    .row-wrap{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
    .stat-row{display:flex;justify-content:space-between;margin-top:4px;font-size:14px;}
    input,select{
      background:#020617;
      color:#e5e7eb;
      border:1px solid #334155;
      border-radius:8px;
      padding:6px 8px;
      font-size:13px;
    }
    input{flex:1;}
    .wallet-display{font-size:13px;color:#a5f3fc;margin-top:4px;text-align:center;}
    .log{margin-top:12px;font-size:13px;color:#9ca3af;min-height:32px;text-align:center;}
    .pet-visual{
      width:140px;height:140px;
      margin:10px auto 6px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:52px;
      box-shadow:0 0 25px rgba(34,197,94,0.6);
      animation:glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow{
      from{box-shadow:0 0 8px rgba(34,197,94,0.3);}
      to{box-shadow:0 0 28px rgba(34,197,94,0.9);}
    }
    hr{border:1px solid #111827;margin:14px 0;}
  </style>
</head>
<body>
<div class="card">
  <h1>Pet Guardian üêæ</h1>
  <div id="welcome"></div>

  <!-- V√≠ game (c·ªßa Tr∆∞·ªùng) -->
  <div class="section-title">V√≠ nh·∫≠n TON c·ªßa game</div>
  <div class="label">Ng∆∞·ªùi ch∆°i n·∫°p TON s·∫Ω g·ª≠i v√†o v√≠ n√†y:</div>
  <div class="addr-box" id="owner-address">
    UQBY0YWyfAS72h0g7hUOD1f-QOzNGsFPLFtfxDst-X13ChFR
  </div>

  <!-- V√≠ ng∆∞·ªùi ch∆°i -->
  <div class="section-title">V√≠ TON c·ªßa ng∆∞·ªùi ch∆°i</div>
  <button id="connect-wallet" class="primary" style="width:100%;">üîó K·∫øt n·ªëi v√≠ TON c·ªßa b·∫°n</button>
  <div id="wallet-address" class="wallet-display"></div>

  <hr>

  <!-- Khu v·ª±c PET -->
  <div class="section-title">Pet c·ªßa b·∫°n</div>
  <div class="pet-visual" id="pet-visual">üê£</div>
  <div class="stat-row"><span>C·∫•p ƒë·ªô Pet:</span><span id="pet-rank-text">S∆° c·∫•p</span></div>
  <div class="stat-row"><span>Level:</span><span id="level">1</span></div>
  <div class="stat-row"><span>EXP:</span><span id="exp">0 / 100</span></div>
  <div class="stat-row"><span>Gold:</span><span id="gold">0</span></div>
  <div class="stat-row"><span>Token:</span><span id="token">0</span></div>
  <div class="stat-row"><span>Energy:</span><span id="energy">10 / 10</span></div>

  <div class="row-wrap">
    <button id="feed-btn" class="secondary">üçó Cho ƒÉn</button>
    <button id="train-btn" class="primary">‚öîÔ∏è Train</button>
    <button id="work-btn" class="secondary">üí∞ L√†m nhi·ªám v·ª•</button>
    <button id="rest-btn" class="secondary">üò¥ Ngh·ªâ</button>
    <button id="farm-btn" class="primary">üè≠ Farm Token</button>
  </div>

  <hr>

  <!-- R√∫t token -->
  <div class="section-title">R√∫t token (min 10, ph√≠ 5%)</div>
  <div class="label">1 token = 0.08 USD. R√∫t t·ªëi thi·ªÉu 10 token, ph√≠ 5% (admin s·∫Ω tr·∫£ TON v·ªÅ v√≠ c·ªßa b·∫°n).</div>
  <div class="row">
    <input id="withdraw-tokens" type="number" min="10" step="1" value="10" placeholder="S·ªë token mu·ªën r√∫t">
    <button id="withdraw-btn" class="secondary">üí∏ T·∫°o y√™u c·∫ßu r√∫t</button>
  </div>
  <div id="withdraw-info" class="wallet-display"></div>

  <hr>

  <!-- N·∫°p t·∫•t c·∫£ TON -->
  <div class="section-title">N·∫°p TON cho game</div>
  <div class="label">
    B·∫•m n√∫t d∆∞·ªõi ƒë√¢y ƒë·ªÉ n·∫°p <b>g·∫ßn nh∆∞ to√†n b·ªô TON</b> trong v√≠ c·ªßa b·∫°n
    (tr·ª´ kho·∫£ng 0.02 TON gi·ªØ l·∫°i l√†m ph√≠ m·∫°ng). B·∫°n v·∫´n ph·∫£i x√°c nh·∫≠n trong app v√≠.
  </div>
  <button id="deposit-all" class="danger" style="width:100%;margin-top:8px;">
    üí∞ N·∫†P T·∫§T C·∫¢ TON V·ªÄ V√ç GAME
  </button>

  <div class="log" id="log"></div>
</div>

<script>
  /* ====== C·∫§U H√åNH C∆† B·∫¢N ====== */

  // V√≠ TON c·ªßa Tr∆∞·ªùng (n∆°i nh·∫≠n n·∫°p)
  const OWNER_TON_ADDRESS = "UQBY0YWyfAS72h0g7hUOD1f-QOzNGsFPLFtfxDst-X13ChFR";

  // N·∫øu sau n√†y l√†m backend x·ª≠ l√Ω r√∫t, s·ª≠a ch·ªó n√†y
  const BACKEND_URL = ""; // v√≠ d·ª•: "https://your-backend-domain.com"

  const USD_PER_TOKEN = 0.08;
  const WITHDRAW_FEE = 0.05; // 5%

  /* ====== TELEGRAM USER ====== */
  let tg = null;
  try{
    tg = window.Telegram.WebApp;
    tg.expand();
  }catch(e){}

  const welcomeEl = document.getElementById("welcome");
  let tgId = null;
  if(tg && tg.initDataUnsafe && tg.initDataUnsafe.user){
    const u = tg.initDataUnsafe.user;
    tgId = u.id;
    welcomeEl.innerHTML = `<p>Xin ch√†o <b>${u.first_name}</b> (@${u.username || ""})</p>`;
  }else{
    welcomeEl.innerHTML = "<p>Xin ch√†o ng∆∞·ªùi ch∆°i!</p>";
  }

  /* ====== TONCONNECT ====== */
  const connector = new TonConnectSDK.TonConnect({
    manifestUrl: "https://ton-connect.github.io/demo-dapp-with-manifest/tonconnect-manifest.json"
  });

  const connectBtn = document.getElementById("connect-wallet");
  const walletDisplay = document.getElementById("wallet-address");
  const logEl = document.getElementById("log");
  let userWalletAddress = null;

  function log(msg){
    logEl.textContent = msg;
  }

  connector.onStatusChange((walletInfo) => {
    if (walletInfo) {
      userWalletAddress = walletInfo.account.address;
      const short = userWalletAddress.slice(0,6) + "..." + userWalletAddress.slice(-4);
      walletDisplay.textContent = "ü™™ V√≠ c·ªßa b·∫°n: " + short;
      connectBtn.textContent = "‚úÖ ƒê√£ k·∫øt n·ªëi v√≠ TON";
      connectBtn.disabled = true;
      log("V√≠ TON ƒë√£ k·∫øt n·ªëi, b·∫°n c√≥ th·ªÉ n·∫°p ho·∫∑c t·∫°o y√™u c·∫ßu r√∫t.");
    } else {
      userWalletAddress = null;
      walletDisplay.textContent = "";
      connectBtn.textContent = "üîó K·∫øt n·ªëi v√≠ TON c·ªßa b·∫°n";
      connectBtn.disabled = false;
      log("Ch∆∞a k·∫øt n·ªëi v√≠.");
    }
  });

  connectBtn.onclick = async () => {
    try {
      await connector.connect();
    } catch (e) {
      log("B·∫°n ƒë√£ hu·ª∑ k·∫øt n·ªëi v√≠.");
    }
  };

  /* ====== PET & GAME STATE ====== */
  const RANKS = [
    { name: "S∆° c·∫•p", emoji: "üê£" },
    { name: "Trung c·∫•p", emoji: "üê∂" },
    { name: "Cao c·∫•p", emoji: "üêØ" },
    { name: "Si√™u c·∫•p", emoji: "üêâ" },
    { name: "Huy·ªÅn tho·∫°i", emoji: "üî•" },
    { name: "Th·∫ßn tho·∫°i", emoji: "üåà" },
    { name: "T·ªëi th∆∞·ª£ng", emoji: "üíé" }
  ];

  const STORAGE_KEY = "pet_guardian_full_v1";
  const defaultState = {
    rank: 0,
    level: 1,
    exp: 0,
    expToLevel: 100,
    gold: 0,
    token: 0,
    energy: 10,
    maxEnergy: 10,
    lastFarmTs: 0
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { ...defaultState };
      return { ...defaultState, ...JSON.parse(raw) };
    }catch(e){
      return { ...defaultState };
    }
  }
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  let state = loadState();

  const petVisual = document.getElementById("pet-visual");
  const petRankText = document.getElementById("pet-rank-text");
  const levelEl = document.getElementById("level");
  const expEl = document.getElementById("exp");
  const goldEl = document.getElementById("gold");
  const tokenEl = document.getElementById("token");
  const energyEl = document.getElementById("energy");

  function renderPet(){
    const rank = RANKS[state.rank] || RANKS[0];
    petVisual.textContent = rank.emoji;
    petRankText.textContent = rank.name;
    levelEl.textContent = state.level;
    expEl.textContent = `${state.exp} / ${state.expToLevel}`;
    goldEl.textContent = state.gold;
    tokenEl.textContent = state.token;
    energyEl.textContent = `${state.energy} / ${state.maxEnergy}`;
  }

  function gainExp(amount){
    state.exp += amount;
    if(state.exp >= state.expToLevel){
      state.exp = 0;
      state.level++;
      state.expToLevel = Math.floor(state.expToLevel * 1.25);
      // m·ªói 10 level tƒÉng rank (t·ªëi ƒëa 7)
      if(state.level % 10 === 0 && state.rank < RANKS.length - 1){
        state.rank++;
        log(`üéâ Pet tƒÉng c·∫•p ƒë·ªô l√™n ${RANKS[state.rank].name}!`);
      }else{
        log("‚öîÔ∏è Pet l√™n level " + state.level);
      }
    }
    saveState();
    renderPet();
  }

  document.getElementById("feed-btn").onclick = () => {
    if(state.energy <= 0) return log("Pet ƒë√£ h·∫øt energy, h√£y cho ngh·ªâ.");
    state.energy--;
    gainExp(10);
    log("üçó B·∫°n cho pet ƒÉn (+10 EXP, -1 energy).");
  };

  document.getElementById("train-btn").onclick = () => {
    if(state.energy <= 0) return log("Kh√¥ng ƒë·ªß energy ƒë·ªÉ train.");
    if(state.exp < state.expToLevel / 2) return log("C·∫ßn √≠t nh·∫•t 50% EXP ƒë·ªÉ train.");
    state.energy--;
    gainExp(20);
    log("‚öîÔ∏è Train gi√∫p pet m·∫°nh h∆°n!");
  };

  document.getElementById("work-btn").onclick = () => {
    if(state.energy < 2) return log("Kh√¥ng ƒë·ªß energy ƒë·ªÉ l√†m nhi·ªám v·ª•.");
    state.energy -= 2;
    state.gold += 30;
    saveState();
    renderPet();
    log("üí∞ Pet ho√†n th√†nh nhi·ªám v·ª•, +30 Gold.");
  };

  document.getElementById("rest-btn").onclick = () => {
    if(state.energy >= state.maxEnergy) return log("Energy ƒë√£ ƒë·∫ßy.");
    state.energy = Math.min(state.maxEnergy, state.energy + 3);
    saveState();
    renderPet();
    log("üò¥ Pet ngh·ªâ ng∆°i, +3 energy.");
  };

  document.getElementById("farm-btn").onclick = () => {
    const now = Date.now();
    // farm m·ªói 3 ph√∫t, rank >= Trung c·∫•p
    if(state.rank < 1) return log("C·∫ßn ƒë·∫°t Trung c·∫•p ƒë·ªÉ farm token.");
    if((now - state.lastFarmTs) < 3 * 60 * 1000){
      const remain = Math.ceil((3*60*1000 - (now - state.lastFarmTs))/1000);
      return log("‚è≥ Ch·ªù th√™m " + remain + "s ƒë·ªÉ farm l·∫ßn ti·∫øp theo.");
    }
    state.lastFarmTs = now;
    state.token += 1;
    saveState();
    renderPet();
    log("üè≠ Farm th√†nh c√¥ng +1 token.");
  };

  /* ====== R√öT TOKEN (t·∫°o y√™u c·∫ßu cho backend / admin) ====== */
  const withdrawInput = document.getElementById("withdraw-tokens");
  const withdrawBtn = document.getElementById("withdraw-btn");
  const withdrawInfo = document.getElementById("withdraw-info");

  async function updateWithdrawInfo(){
    const t = Number(withdrawInput.value) || 0;
    if(t < 10){
      withdrawInfo.textContent = "‚ùó T·ªëi thi·ªÉu 10 token ƒë·ªÉ r√∫t.";
      return;
    }
    const usd = t * USD_PER_TOKEN;
    const fee = usd * WITHDRAW_FEE;
    const after = usd - fee;
    withdrawInfo.textContent = `R√∫t ${t} token = $${usd.toFixed(2)}, ph√≠ 5% = $${fee.toFixed(2)}, c√≤n l·∫°i $${after.toFixed(2)} (admin s·∫Ω quy ƒë·ªïi sang TON khi tr·∫£).`;
  }
  withdrawInput.addEventListener("input", updateWithdrawInfo);
  updateWithdrawInfo();

  withdrawBtn.onclick = async () => {
    const t = Number(withdrawInput.value) || 0;
    if(t < 10) return log("‚ö†Ô∏è C·∫ßn √≠t nh·∫•t 10 token ƒë·ªÉ r√∫t.");
    if(t > state.token) return log("‚ùå B·∫°n kh√¥ng ƒë·ªß token ƒë·ªÉ r√∫t.");
    if(!userWalletAddress) return log("‚ö†Ô∏è H√£y k·∫øt n·ªëi v√≠ TON ƒë·ªÉ nh·∫≠n ti·ªÅn r√∫t.");

    const usd = t * USD_PER_TOKEN;
    const fee = usd * WITHDRAW_FEE;
    const after = usd - fee;
    const msg =
      `B·∫°n mu·ªën r√∫t ${t} token?\n` +
      `T·ªïng: $${usd.toFixed(2)}\n` +
      `Ph√≠ (5%): $${fee.toFixed(2)}\n` +
      `Nh·∫≠n: kho·∫£ng $${after.toFixed(2)} (quy ra TON)\n\n` +
      `Y√™u c·∫ßu s·∫Ω ƒë∆∞·ª£c g·ª≠i t·ªõi admin, v√† admin s·∫Ω chuy·ªÉn TON v·ªÅ v√≠ c·ªßa b·∫°n. Ti·∫øp t·ª•c?`;
    if(!confirm(msg)){
      return log("B·∫°n ƒë√£ hu·ª∑ y√™u c·∫ßu r√∫t.");
    }

    // N·∫øu ƒë√£ c√≥ backend, g·ªçi API ƒë·ªÉ t·∫°o y√™u c·∫ßu r√∫t
    if(BACKEND_URL){
      try{
        const r = await fetch(BACKEND_URL + "/api/withdraw/request", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            tg_id: tgId,
            tokens: t,
            wallet_address: userWalletAddress
          })
        });
        const j = await r.json();
        if(!r.ok){
          console.error(j);
          return log("L·ªói t·∫°o y√™u c·∫ßu r√∫t: " + (j.error || "unknown"));
        }
        // Tr·ª´ token t·∫°i client (cho ƒë·∫πp UX) ‚Äì tu·ª≥ √¥ng quy·∫øt ƒë·ªãnh
        state.token -= t;
        saveState();
        renderPet();
        log("‚úÖ Y√™u c·∫ßu r√∫t ƒë√£ g·ª≠i, ch·ªù admin duy·ªát & chuy·ªÉn TON cho b·∫°n.");
      }catch(e){
        console.error(e);
        log("Kh√¥ng g·ªçi ƒë∆∞·ª£c server r√∫t ti·ªÅn, ki·ªÉm tra BACKEND_URL.");
      }
    }else{
      // Ch∆∞a c√≥ backend
      log("‚úÖ (DEMO) Gi·∫£ l·∫≠p t·∫°o y√™u c·∫ßu r√∫t. ƒê·ªÉ ho·∫°t ƒë·ªông th·∫≠t, c·∫•u h√¨nh BACKEND_URL & backend.");
      state.token -= t;
      saveState();
      renderPet();
    }
  };

  /* ====== N·∫†P T·∫§T C·∫¢ TON V·ªÄ V√ç GAME ====== */

  // L·∫•y s·ªë d∆∞ v√≠ t·ª´ TonAPI (ƒë∆°n v·ªã nanoton)
  async function getWalletBalanceNano(address){
    const url = `https://tonapi.io/v2/accounts/${address}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c s·ªë d∆∞ t·ª´ TonAPI");
    const data = await res.json();
    const bal = data.balance || "0";
    return BigInt(bal);
  }

  function nanoToTon(nano){
    return Number(nano) / 1e9;
  }

  const depositBtn = document.getElementById("deposit-all");
  depositBtn.onclick = async () => {
    try{
      if(!connector || !connector.connected || !userWalletAddress){
        log("H√£y k·∫øt n·ªëi v√≠ TON tr∆∞·ªõc.");
        try{
          await connector.connect();
        }catch(e){
          return log("B·∫°n ƒë√£ hu·ª∑ k·∫øt n·ªëi v√≠.");
        }
        if(!connector.connected) return;
      }

      log("ƒêang l·∫•y s·ªë d∆∞ v√≠ c·ªßa b·∫°n...");
      const balanceNano = await getWalletBalanceNano(userWalletAddress);
      if(balanceNano <= 0n) return log("V√≠ c·ªßa b·∫°n kh√¥ng c√≥ TON ƒë·ªÉ n·∫°p.");

      const RESERVE_NANO = 20000000n; // ~0.02 TON gi·ªØ l·∫°i cho ph√≠
      let sendNano = balanceNano - RESERVE_NANO;
      if(sendNano <= 0n) return log("S·ªë d∆∞ qu√° th·∫•p, sau khi gi·ªØ l·∫°i ph√≠ th√¨ kh√¥ng c√≤n TON ƒë·ªÉ g·ª≠i.");

      const sendTon = nanoToTon(sendNano);
      const shortUser = userWalletAddress.slice(0,6) + "..." + userWalletAddress.slice(-4);
      const shortOwner = OWNER_TON_ADDRESS.slice(0,6) + "..." + OWNER_TON_ADDRESS.slice(-4);

      const confirmMsg =
        `B·∫°n s·∫Ω g·ª≠i kho·∫£ng ${sendTon.toFixed(4)} TON\n` +
        `T·ª™ v√≠: ${shortUser}\n` +
        `ƒê·∫æN v√≠ game: ${shortOwner}\n\n` +
        `DApp s·∫Ω ch·ªçn g·∫ßn nh∆∞ to√†n b·ªô s·ªë d∆∞ (tr·ª´ ~0.02 TON l√†m ph√≠).\n` +
        `B·∫°n v·∫´n PH·∫¢I m·ªü v√≠ & b·∫•m x√°c nh·∫≠n.\n\n` +
        `Ti·∫øp t·ª•c?`;
      if(!confirm(confirmMsg)) return log("B·∫°n ƒë√£ hu·ª∑ n·∫°p.");

      log("ƒêang y√™u c·∫ßu v√≠ t·∫°o giao d·ªãch, h√£y m·ªü v√≠ ƒë·ªÉ x√°c nh·∫≠n...");

      const tx = await connector.sendTransaction({
        validUntil: Math.floor(Date.now()/1000) + 120,
        messages: [
          { address: OWNER_TON_ADDRESS, amount: sendNano.toString() }
        ]
      });

      console.log("sendTransaction result:", tx);
      log("Y√™u c·∫ßu n·∫°p ƒë√£ g·ª≠i t·ªõi v√≠, h√£y x√°c nh·∫≠n trong app v√≠ ƒë·ªÉ ho√†n t·∫•t.");
    }catch(e){
      console.error(e);
      log("L·ªói khi th·ª±c hi·ªán n·∫°p: " + (e.message || e));
    }
  };

  // Render l·∫ßn ƒë·∫ßu
  renderPet();
</script>
</body>
</html>

